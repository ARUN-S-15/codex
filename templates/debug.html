<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CODEX - Debug Code</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CodeMirror Editor -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
  
  <style>
    .issues-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.2rem;
      margin: 1rem 0;
    }
    @media (max-width: 900px) {
      .issues-grid {
        grid-template-columns: 1fr;
      }
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #000;
      color: #fff;
    }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #202123;
      padding: 1rem 2rem;
      border-bottom: 1px solid #2a2b32;
    }

    nav .logo {
      font-weight: 700;
      font-size: 1.3rem;
      color: #10a37f;
    }

    nav ul {
      display: flex;
      list-style: none;
      gap: 1.5rem;
    }

    nav ul li a {
      text-decoration: none;
      color: #ececf1;
      font-weight: 500;
    }

    nav ul li a.active {
      color: #10a37f;
    }

    /* Layout - Single column like compiler */
    .main-container {
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 70px);
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      gap: 1.5rem;
    }

    /* Editor */
    .editor-section {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .editor-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      background: #1d1d1d;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .code-wrapper {
      position: relative;
      flex: 1;
      display: flex;
    }
    
    .syntax-highlight {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: 0;
      padding: 1rem;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 1.1rem;
      line-height: 1.7rem;
      pointer-events: none;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
      background: transparent;
      border: none;
      tab-size: 4;
      z-index: 0;
      letter-spacing: 0;
      word-spacing: 0;
    }
    
    .syntax-highlight code {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
      font-size: 1.1rem !important;
      line-height: 1.7rem !important;
      background: transparent !important;
      padding: 0 !important;
      margin: 0 !important;
      letter-spacing: 0 !important;
      word-spacing: 0 !important;
    }

   /* Line numbers */
   .line-numbers {
      background: #2a2b32;
      color: #9ca3af;
      padding: 1rem 0.8rem;
      text-align: right;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 1.1rem;
      border-radius: 10px 0 0 10px;
      user-select: none;
      white-space: pre;
      line-height: 1.7rem;
      overflow: hidden;
      min-width: 50px;
      letter-spacing: 0;
      word-spacing: 0;
    }

    /* CodeMirror Editor Styles */
    .CodeMirror {
      height: 80vh !important;
      min-height: 80vh;
      font-size: 1.1rem !important;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
      background: #1d1d1d !important;
      color: #ececf1 !important;
      border-radius: 8px;
    }
    
    .CodeMirror-gutters {
      background: #2a2b32 !important;
      border-right: 1px solid #3a3b42 !important;
    }
    
    .CodeMirror-linenumber {
      color: #9ca3af !important;
      padding: 0 0.8rem !important;
    }
    
    .CodeMirror-cursor {
      border-left: 2px solid #10a37f !important;
    }
    
    .CodeMirror-selected {
      background: rgba(16, 163, 127, 0.3) !important;
    }
    
    .CodeMirror-line {
      padding: 0 0.5rem !important;
      line-height: 1.8 !important;
    }
    
    .CodeMirror-lines {
      padding: 8px 0 !important;
    }
    
    .editor-container {
      position: relative;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .copy-btn {
      position: absolute;
      top: 0.6rem;
      right: 0.6rem;
      background: rgba(42, 43, 50, 0.95);
      border: 1px solid rgba(88, 166, 255, 0.2);
      color: #c9d1d9;
      padding: 0.4rem 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      z-index: 1000;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      backdrop-filter: blur(10px);
    }

    .copy-btn:hover {
      background: rgba(88, 166, 255, 0.15);
      border-color: #58a6ff;
      color: #58a6ff;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(88, 166, 255, 0.2);
    }
    
    .copy-btn:active {
      transform: translateY(0);
    }

    #debugBtn {
      margin-top: 1rem;
      padding: 0.8rem;
      background: #10a37f;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }

    #debugBtn:hover {
      background: #0d8b6d;
    }

    /* Results section - below editor */
    .results {
      width: 100%;
      display: none;
      flex-direction: column;
      animation: fadeIn 0.5s ease-in-out;
    }

    .result-box {
      position: relative;
      display: flex;
      flex-direction: column;
      background: #1d1d1d;
      border-radius: 10px;
      overflow: hidden;
    }

    .result-box h3 {
      margin: 0;
      padding: 0.8rem 1rem;
      background: #40414f;
      color: #10a37f;
      font-size: 1.1rem;
      font-weight: 600;
      border-bottom: 1px solid #2a2b32;
    }

    /* ChatGPT-style issues display */
    #issues {
      flex: 1;
      background: #1d1d1d;
      color: #ececf1;
      padding: 0;
      border-radius: 10px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 0.95rem;
      margin: 0;
      overflow: auto;
      line-height: 1.6;
    }
    
    /* Issue card styling */
    .issue-card {
      background: linear-gradient(135deg, rgba(255, 84, 89, 0.1) 0%, rgba(255, 84, 89, 0.05) 100%);
      border-left: 4px solid #ff5459;
      border-radius: 8px;
      padding: 1rem 1.2rem;
      margin: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease;
    }
    
    .issue-card:hover {
      transform: translateX(4px);
    }
    
    .warning-card {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
      border-left-color: #ffc107;
    }
    
    .success-card {
      background: linear-gradient(135deg, rgba(16, 163, 127, 0.15) 0%, rgba(16, 163, 127, 0.05) 100%);
      border-left-color: #10a37f;
    }
    
    .issue-badge {
      display: inline-block;
      padding: 0.3rem 0.7rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }
    
    .error-badge {
      background: #ff5459;
      color: #fff;
    }
    
    .warning-badge {
      background: #ffc107;
      color: #000;
    }
    
    .success-badge {
      background: #10a37f;
      color: #fff;
    }
    
    .issue-title {
      color: #ececf1;
      font-size: 1rem;
      font-weight: 600;
      margin: 0.5rem 0;
      line-height: 1.4;
    }
    
    .issue-description {
      color: #b4b4b4;
      font-size: 0.9rem;
      line-height: 1.6;
      margin-top: 0.5rem;
    }
    
    .issue-code {
      background: #0d0d0d;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 0.5rem 0.8rem;
      margin-top: 0.5rem;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85rem;
      color: #6ad7ff;
      overflow-x: auto;
    }
    
    .success-message {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #10a37f;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
    }
    
    .success-message::before {
      content: "‚úì";
      display: inline-block;
      width: 40px;
      height: 40px;
      line-height: 40px;
      background: #10a37f;
      color: #fff;
      border-radius: 50%;
      margin-right: 1rem;
      font-size: 1.5rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    footer {
      text-align: center;
      padding: 0.7rem;
      border-top: 1px solid #2a2b32;
      font-size: 0.9rem;
      color: #aaa;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav>
    <div class="logo">‚ö° CODEX ‚ö°</div>
    <ul>
      <li><a href="{{ url_for('main') }}">History</a></li>
      <li><a href="{{ url_for('compiler') }}">Compiler</a></li>
      <li><a href="#">About</a></li>
      <li><a href="#">Contact</a></li>
      <li><a href="{{ url_for('logout') }}">Logout</a></li>
    </ul>
  </nav>

  <!-- MAIN LAYOUT -->
  <div class="main-container">
    <!-- Hidden Input for localStorage -->
    <textarea id="codeInput" style="display: none;"></textarea>
    
    <!-- Debugged/Fixed Code Section -->
    <div class="editor-section">
      <h3 style="color: #10a37f; margin-bottom: 0.5rem;">ÔøΩ Debugged Code</h3>
      <div class="editor-container">
        <button class="copy-btn" id="copyFixedBtn">üìã Copy</button>
        <textarea id="debuggedCode" placeholder="Debugged code will appear here..."></textarea>
      </div>
      <button id="debugBtn">üêû Re-Debug Code</button>
    </div>

    <!-- Issues Found Section (Below) -->
    <div class="results" id="results" style="display: none;">
      <div class="result-box">
        <h3>üîç Issues Found</h3>
        <div style="position: relative;">
          <div id="issues" style="min-height: 300px; padding: 1rem; overflow: auto;">
            <p style="padding: 2rem; text-align: center; color: #888;">Click "Analyze & Debug Code" to see issues and get fixes.</p>
          </div>
          <button class="copy-btn" id="copyIssuesBtn" style="top: 1rem; right: 1rem;">üìã Copy Issues</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <p>¬© 2025 CODEX. All rights reserved.</p>
  </footer>

  <script>
  const debugBtn = document.getElementById("debugBtn");
  const issuesBox = document.getElementById("issues");
  const results = document.getElementById("results");
  const codeInputTextarea = document.getElementById("codeInput");
  const debuggedCodeTextarea = document.getElementById("debuggedCode");

  let currentLanguage = "python"; // default
  
  // ============================================
  // CODEMIRROR INITIALIZATION
  // ============================================
  const languageModeMap = {
    "python": "python",
    "javascript": "javascript",
    "java": "text/x-java",
    "cpp": "text/x-c++src",
    "c++": "text/x-c++src",
    "c": "text/x-csrc"
  };
  
  // Initialize CodeMirror for debugged code only
  const codeMirrorDebuggedCode = CodeMirror.fromTextArea(debuggedCodeTextarea, {
    mode: "python",
    theme: "monokai",
    lineNumbers: true,
    readOnly: false,
    indentUnit: 4,
    tabSize: 4,
    lineWrapping: true,
    autoCloseBrackets: true,
    matchBrackets: true,
    styleActiveLine: true,
    extraKeys: {
      "Tab": (cm) => cm.execCommand("indentMore"),
      "Shift-Tab": (cm) => cm.execCommand("indentLess"),
      "F8": (cm) => { 
        if (debugBtn) { 
          debugBtn.click(); 
          return false; 
        } 
      },
      "Alt-Shift-Up": (cm) => {
        const cursor = cm.getCursor();
        const line = cm.getLine(cursor.line);
        cm.replaceRange(line + "\n", {line: cursor.line, ch: 0});
        cm.setCursor({line: cursor.line, ch: cursor.ch});
      },
      "Alt-Shift-Down": (cm) => {
        const cursor = cm.getCursor();
        const line = cm.getLine(cursor.line);
        cm.replaceRange("\n" + line, {line: cursor.line, ch: line.length});
        cm.setCursor({line: cursor.line + 1, ch: cursor.ch});
      },
      "Alt-Up": (cm) => {
        const cursor = cm.getCursor();
        if (cursor.line === 0) return;
        const line = cm.getLine(cursor.line);
        const prevLine = cm.getLine(cursor.line - 1);
        cm.replaceRange(line + "\n" + prevLine, {line: cursor.line - 1, ch: 0}, {line: cursor.line + 1, ch: 0});
        cm.setCursor({line: cursor.line - 1, ch: cursor.ch});
      },
      "Alt-Down": (cm) => {
        const cursor = cm.getCursor();
        if (cursor.line === cm.lineCount() - 1) return;
        const line = cm.getLine(cursor.line);
        const nextLine = cm.getLine(cursor.line + 1);
        cm.replaceRange(nextLine + "\n" + line, {line: cursor.line, ch: 0}, {line: cursor.line + 2, ch: 0});
        cm.setCursor({line: cursor.line + 1, ch: cursor.ch});
      },
      "Ctrl-/": (cm) => {
        cm.toggleComment();
      },
      "Ctrl-D": (cm) => {
        const cursor = cm.getCursor();
        cm.replaceRange("", {line: cursor.line, ch: 0}, {line: cursor.line + 1, ch: 0});
      },
      "Ctrl-Shift-D": (cm) => {
        if (cm.somethingSelected()) {
          const selections = cm.getSelections();
          cm.replaceSelections(selections.concat(selections));
        } else {
          const cursor = cm.getCursor();
          const line = cm.getLine(cursor.line);
          cm.replaceRange("\n" + line, {line: cursor.line, ch: line.length});
          cm.setCursor({line: cursor.line + 1, ch: cursor.ch});
        }
      },
      "Ctrl-F": "find",
      "Ctrl-H": "replace",
      "Ctrl-G": "findNext",
      "Ctrl-Shift-G": "findPrev",
      "Ctrl-L": (cm) => {
        const line = prompt("Go to line:", "");
        if (line) {
          cm.setCursor(parseInt(line) - 1, 0);
        }
      },
      "Ctrl-A": "selectAll",
      "Ctrl-Z": "undo",
      "Ctrl-Y": "redo",
      "Ctrl-Shift-Z": "redo",
      "Ctrl-U": (cm) => {
        const selections = cm.getSelections();
        cm.replaceSelections(selections.map(s => s.toUpperCase()));
      },
      "Ctrl-Shift-U": (cm) => {
        const selections = cm.getSelections();
        cm.replaceSelections(selections.map(s => s.toLowerCase()));
      }
    }
  });

  // Load code from localStorage if available (sent from compiler page)
  window.addEventListener("DOMContentLoaded", () => {
    const savedCode = localStorage.getItem("debugCode");
    const savedLanguage = localStorage.getItem("debugLanguage");
    
    if (savedCode) {
      // Store in hidden textarea
      codeInputTextarea.value = savedCode;
      
      // Detect and set language mode
      if (savedLanguage) {
        currentLanguage = savedLanguage.toLowerCase();
        const mode = languageModeMap[currentLanguage] || "python";
        codeMirrorDebuggedCode.setOption("mode", mode);
      }
      
      // Auto-run debug analysis
      runDebugAnalysis(savedCode);
      
      // Clear localStorage after loading
      localStorage.removeItem("debugCode");
      localStorage.removeItem("debugLanguage");
    }
  });

  // Old functions replaced by CodeMirror
  function updateLineNumbers() {} // CodeMirror handles this
  function updateSyntaxHighlight() {} // CodeMirror handles this
  function syncScroll() {} // CodeMirror handles this

  // Format issues for ChatGPT-style display
  function formatIssues(issuesText) {
    if (!issuesText || issuesText.includes("No issues found") || issuesText.startsWith("‚úÖ")) {
      return '<div class="success-message">üéâ No issues found! Your code looks good. üöÄ</div>';
    }

    if (issuesText.startsWith("‚ùå") || issuesText.startsWith("‚ö†Ô∏è")) {
      return `<div style="padding: 1rem; color: #ff5459; font-size: 1.1rem;">${issuesText} üò¢</div>`;
    }

    // Parse issues and create cards
    const lines = issuesText.split('\n').filter(line => line.trim());
    let formattedHTML = '';
    let currentIssue = null;

    for (let line of lines) {
      // Check if it's a new issue (starts with line number or error type)
      const issueMatch = line.match(/^(.*?):(\d+):(\d+):\s*(error|warning|note):\s*(.+)$/i);
      const simpleMatch = line.match(/^(Line \d+|Error|Warning):\s*(.+)$/i);

      if (issueMatch) {
        if (currentIssue) formattedHTML += createIssueCard(currentIssue);
        const [, file, lineNum, col, type, message] = issueMatch;
        currentIssue = {
          type: type.toLowerCase(),
          line: lineNum,
          title: message,
          description: '',
          code: ''
        };
      } else if (simpleMatch) {
        if (currentIssue) formattedHTML += createIssueCard(currentIssue);
        const [, location, message] = simpleMatch;
        currentIssue = {
          type: location.toLowerCase().includes('warning') ? 'warning' : 'error',
          line: location.match(/\d+/) ? location.match(/\d+/)[0] : '?',
          title: message,
          description: '',
          code: ''
        };
      } else if (currentIssue && line.trim()) {
        // Additional description or code
        if (line.match(/^\s{2,}/) || line.includes('>>>') || line.includes('^')) {
          currentIssue.code += line + '\n';
        } else {
          currentIssue.description += line + ' ';
        }
      }
    }

    if (currentIssue) formattedHTML += createIssueCard(currentIssue);

    // If no formatted HTML was created, show raw text
    if (!formattedHTML || formattedHTML.trim() === '') {
      return `<div style="padding: 1.5rem; color: #ececf1; background: rgba(255, 84, 89, 0.1); border-left: 4px solid #ff5459; border-radius: 8px; margin: 1rem; line-height: 1.8; white-space: pre-wrap; font-family: 'Segoe UI', sans-serif;">${escapeHtml(issuesText)}</div>`;
    }

    // Wrap all cards in a grid container for more color and spacing
    return `<div class="issues-grid">${formattedHTML}</div>`;
  }

  function createIssueCard(issue) {
    const colorMap = {
      'error': '#ff5459',
      'warning': '#ffc107',
      'note': '#6ad7ff'
    };
    const emojiMap = {
      'error': '‚ùå',
      'warning': '‚ö†Ô∏è',
      'note': 'üí°'
    };
    const cardClass = issue.type === 'warning' ? 'warning-card' : 'issue-card';
    const badgeClass = issue.type === 'warning' ? 'warning-badge' : 'error-badge';
    const badgeText = issue.type === 'warning' ? 'Warning' : (issue.type === 'note' ? 'Note' : 'Error');
    const color = colorMap[issue.type] || '#10a37f';
    const emoji = emojiMap[issue.type] || 'üêû';

    let html = `<div class="${cardClass}" style="background: linear-gradient(135deg, ${color}22 0%, #222 100%); border-left: 6px solid ${color}; box-shadow: 0 2px 8px ${color}33; margin: 1rem; padding: 1.2rem 1.5rem; border-radius: 12px; display: flex; flex-direction: column; gap: 0.5rem;">`;
    html += `<span class="issue-badge ${badgeClass}" style="background: ${color}; color: #fff;">${emoji} ${badgeText}</span>`;
    html += ` <span style="color: #888; font-size: 0.85rem;">üìç Line ${issue.line}</span>`;
    html += `<div class="issue-title" style="color: ${color}; font-size: 1.05rem; font-weight: 600; margin: 0.5rem 0;">${escapeHtml(issue.title)}</div>`;

    if (issue.description.trim()) {
      html += `<div class="issue-description" style="color: #ececf1;">${escapeHtml(issue.description.trim())}</div>`;
    }

    if (issue.code.trim()) {
      html += `<div class="issue-code" style="background: #181818; color: #6ad7ff; border-radius: 6px; padding: 0.3rem 0.7rem; margin: 0.3rem 0; font-family: 'Consolas', monospace; font-size: 0.95rem;">${escapeHtml(issue.code.trim())}</div>`;
    }

    html += '</div>';
    return html;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Debug analysis function
  async function runDebugAnalysis(code = null) {
    const codeToAnalyze = code || codeInputTextarea.value.trim();
    
    console.log("Running debug analysis with code:", codeToAnalyze ? "Code present" : "No code");
    
    if (!codeToAnalyze || !codeToAnalyze.trim()) {
      issuesBox.innerHTML = '<div style="padding: 2rem; text-align: center; color: #ffa500;">‚ö†Ô∏è No code to analyze.<br><br>Go to the <a href="/compiler" style="color: #10a37f;">compiler page</a> and click the Debug button.</div>';
      codeMirrorDebuggedCode.setValue("");
      results.style.display = "block";
      return;
    }

    // Check for runtime error from compiler
    const runtimeError = localStorage.getItem("runtimeError");
    const errorCode = localStorage.getItem("errorCode");
    
    // Show loading state
    let loadingMessage = 'üêû Analyzing your code with linters...<br>‚è≥ Please wait...';
    if (runtimeError && errorCode === codeToAnalyze) {
      loadingMessage = 'üî• Analyzing runtime error...<br>‚è≥ Please wait...';
    }
    
    issuesBox.innerHTML = '<div style="padding: 2rem; text-align: center; color: #10a37f;">' + loadingMessage + '</div>';
    results.style.display = "block";

    try {
      console.log("Sending debug request with language:", currentLanguage);
      const response = await fetch("/debug", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: codeToAnalyze, language: currentLanguage })
      });

      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }

      const data = await response.json();
      console.log("Debug response received:", data);
      
      // Display auto-fixed code in debugged code editor
      if (data.fixed_code) {
        codeMirrorDebuggedCode.setValue(data.fixed_code);
      } else {
        codeMirrorDebuggedCode.setValue("# Unable to auto-fix\n\n" + codeToAnalyze);
      }
      
      // Refresh CodeMirror
      setTimeout(() => codeMirrorDebuggedCode.refresh(), 100);
      
      // Display issues found by linter in right panel with better formatting
      const issuesText = data.issues || "‚úÖ No issues found! Your code looks good.";
      console.log("Issues text received:", issuesText);
      console.log("Issues text type:", typeof issuesText);
      console.log("Issues text length:", issuesText.length);
      
      let finalIssuesHTML = '';
      
      // Check if there's a runtime error to display
      const runtimeError = localStorage.getItem("runtimeError");
      const errorCode = localStorage.getItem("errorCode");
      
      if (runtimeError && errorCode === codeToAnalyze) {
        // Display the runtime error prominently at the top
        finalIssuesHTML = `
          <div class="issue-card" style="border-left: 5px solid #ff0000; background: linear-gradient(135deg, #2a0a0a 0%, #1a1a1a 100%);">
            <span class="issue-badge" style="background: #ff0000; color: white; font-weight: bold;">üî• RUNTIME ERROR</span>
            <div class="issue-title" style="color: #ff6b6b; font-size: 1.2em; margin-top: 0.5rem;">Your Code Crashed During Execution</div>
            <div class="issue-description" style="margin-top: 0.8rem;">
              <strong>What happened:</strong><br>
              Your code ran but encountered an error and stopped. Here's what went wrong:
            </div>
            <pre class="issue-code" style="background: #1a1a1a; border: 1px solid #ff0000; padding: 1rem; margin-top: 1rem; border-radius: 6px; overflow-x: auto; color: #ff6b6b; font-family: 'Courier New', monospace; font-size: 0.9em; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(runtimeError)}</pre>
            <div class="issue-description" style="margin-top: 1rem; border-top: 1px solid #333; padding-top: 1rem;">
              <strong>üí° How to fix it:</strong><br>
              The detailed analysis below will help you understand and fix this error. Look for the specific line mentioned in the error message and check the suggestions.
            </div>
          </div>
          <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #333;">
            <div style="color: #10a37f; font-weight: bold; margin-bottom: 1rem; font-size: 1.1em;">üìã Detailed Analysis:</div>
          </div>
        `;
        
        // Clear the stored error after displaying
        localStorage.removeItem("runtimeError");
        localStorage.removeItem("errorCode");
        localStorage.removeItem("errorLanguage");
      }
      
      if (!issuesText || issuesText.trim() === '') {
        issuesBox.innerHTML = finalIssuesHTML + '<div style="padding: 2rem; text-align: center; color: #888;">No issues data received from server.</div>';
      } else {
        const formattedIssues = formatIssues(issuesText);
        console.log("Formatted issues HTML length:", formattedIssues.length);
        issuesBox.innerHTML = finalIssuesHTML + formattedIssues;
      }

    } catch (err) {
      issuesBox.innerHTML = '<div class="issue-card"><span class="issue-badge error-badge">Error</span><div class="issue-title">Analysis Failed</div><div class="issue-description">' + err.message + '</div></div>';
      codeInput.value = "# Error during analysis\n\n" + codeToAnalyze;
      updateLineNumbers();
      updateSyntaxHighlight();
    }
  }

  // Debug button handler - re-analyze current code
  debugBtn.addEventListener("click", () => {
    const currentCode = codeInputTextarea.value.trim();
    if (currentCode) {
      runDebugAnalysis(currentCode);
    } else {
      issuesBox.innerHTML = '<div style="padding: 2rem; text-align: center; color: #ffa500;">‚ö†Ô∏è No code to analyze.<br><br>Please go to the <a href="/compiler" style="color: #10a37f;">compiler page</a> and click the Debug button.</div>';
      results.style.display = "block";
    }
  });

  // Copy Buttons with better feedback
  document.getElementById("copyFixedBtn").addEventListener("click", () => {
    navigator.clipboard.writeText(codeMirrorDebuggedCode.getValue()).then(() => {
      const btn = document.getElementById("copyFixedBtn");
      const originalText = btn.textContent;
      btn.textContent = "‚úì Copied!";
      btn.style.background = "#10a37f";
      btn.style.color = "#fff";
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = "";
      }, 2000);
    });
  });

  document.getElementById("copyIssuesBtn").addEventListener("click", () => {
    navigator.clipboard.writeText(issuesBox.textContent).then(() => {
      const btn = document.getElementById("copyIssuesBtn");
      const originalText = btn.textContent;
      btn.textContent = "‚úì Copied!";
      btn.style.background = "#10a37f";
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = "";
      }, 2000);
    });
  });
</script>

</body>
</html>
