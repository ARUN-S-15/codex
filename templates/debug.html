<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CODEX - Debug Code</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Prism.js for Syntax Highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
  
  <style>
    .issues-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.2rem;
      margin: 1rem 0;
    }
    @media (max-width: 900px) {
      .issues-grid {
        grid-template-columns: 1fr;
      }
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #000;
      color: #fff;
    }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #202123;
      padding: 1rem 2rem;
      border-bottom: 1px solid #2a2b32;
    }

    nav .logo {
      font-weight: 700;
      font-size: 1.3rem;
      color: #10a37f;
    }

    nav ul {
      display: flex;
      list-style: none;
      gap: 1.5rem;
    }

    nav ul li a {
      text-decoration: none;
      color: #ececf1;
      font-weight: 500;
    }

    nav ul li a.active {
      color: #10a37f;
    }

    /* Layout */
    .main-container {
      display: flex;
      height: calc(100vh - 70px);
    }

    /* History Box */
    .history {
      width: 15%;
      background: #111;
      border-right: 1px solid #2a2b32;
      padding: 1rem;
      overflow-y: auto;
    }

    .history h2 {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: #10a37f;
    }

    .history p {
      font-size: 0.9rem;
      background: #1e1e1e;
      padding: 0.5rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }

    /* Editor */
    .editor-section {
      width: 45%;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }

    .editor-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      background: #1d1d1d;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .code-wrapper {
      position: relative;
      flex: 1;
      display: flex;
    }
    
    .syntax-highlight {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: 0;
      padding: 1rem;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 1.1rem;
      line-height: 1.7rem;
      pointer-events: none;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
      background: transparent;
      border: none;
      tab-size: 4;
      z-index: 0;
    }
    
    .syntax-highlight code {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
      font-size: 1.1rem !important;
      line-height: 1.7rem !important;
      background: transparent !important;
      padding: 0 !important;
      margin: 0 !important;
    }

   /* Line numbers */
   .line-numbers {
      background: #2a2b32;
      color: #9ca3af;
      padding: 1rem 0.5rem;
      text-align: right;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 1.1rem;
      border-radius: 10px 0 0 10px;
      user-select: none;
      white-space: pre;
      line-height: 1.7rem;
      overflow: hidden;
    }

    textarea {
      position: relative;
      flex: 1;
      background: transparent;
      color: transparent;
      border: none;
      border-radius: 0 10px 10px 0;
      padding: 1rem;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 1.1rem;
      resize: none;
      outline: none;
      line-height: 1.7rem;
      tab-size: 4;
      caret-color: #ececf1;
      -webkit-text-fill-color: transparent;
      z-index: 1;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    textarea::placeholder {
      color: #666;
      -webkit-text-fill-color: #666;
    }
    
    textarea::selection {
      background: rgba(16, 163, 127, 0.3);
    }

    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 0.3rem 0.7rem;
      background: #10a37f;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .copy-btn:hover {
      background: #0d8b6d;
    }

    #debugBtn {
      margin-top: 1rem;
      padding: 0.8rem;
      background: #10a37f;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }

    #debugBtn:hover {
      background: #0d8b6d;
    }

    /* Results side - Issues only */
    .results {
      width: 40%;
      padding: 1rem;
      display: none;
      flex-direction: column;
      animation: fadeIn 0.5s ease-in-out;
    }

    .result-box {
      position: relative;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .result-box h3 {
      margin: 0 0 0.5rem 0;
      color: #10a37f;
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* ChatGPT-style issues display */
    #issues {
      flex: 1;
      background: #1d1d1d;
      color: #ececf1;
      padding: 0;
      border-radius: 10px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 0.95rem;
      margin: 0;
      overflow: auto;
      line-height: 1.6;
    }
    
    /* Issue card styling */
    .issue-card {
      background: linear-gradient(135deg, rgba(255, 84, 89, 0.1) 0%, rgba(255, 84, 89, 0.05) 100%);
      border-left: 4px solid #ff5459;
      border-radius: 8px;
      padding: 1rem 1.2rem;
      margin: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease;
    }
    
    .issue-card:hover {
      transform: translateX(4px);
    }
    
    .warning-card {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
      border-left-color: #ffc107;
    }
    
    .success-card {
      background: linear-gradient(135deg, rgba(16, 163, 127, 0.15) 0%, rgba(16, 163, 127, 0.05) 100%);
      border-left-color: #10a37f;
    }
    
    .issue-badge {
      display: inline-block;
      padding: 0.3rem 0.7rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }
    
    .error-badge {
      background: #ff5459;
      color: #fff;
    }
    
    .warning-badge {
      background: #ffc107;
      color: #000;
    }
    
    .success-badge {
      background: #10a37f;
      color: #fff;
    }
    
    .issue-title {
      color: #ececf1;
      font-size: 1rem;
      font-weight: 600;
      margin: 0.5rem 0;
      line-height: 1.4;
    }
    
    .issue-description {
      color: #b4b4b4;
      font-size: 0.9rem;
      line-height: 1.6;
      margin-top: 0.5rem;
    }
    
    .issue-code {
      background: #0d0d0d;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 0.5rem 0.8rem;
      margin-top: 0.5rem;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85rem;
      color: #6ad7ff;
      overflow-x: auto;
    }
    
    .success-message {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #10a37f;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
    }
    
    .success-message::before {
      content: "‚úì";
      display: inline-block;
      width: 40px;
      height: 40px;
      line-height: 40px;
      background: #10a37f;
      color: #fff;
      border-radius: 50%;
      margin-right: 1rem;
      font-size: 1.5rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    footer {
      text-align: center;
      padding: 0.7rem;
      border-top: 1px solid #2a2b32;
      font-size: 0.9rem;
      color: #aaa;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav>
    <div class="logo">‚ö° CODEX ‚ö°</div>
    <ul>
      <li><a href="{{ url_for('main') }}">History</a></li>
      <li><a href="{{ url_for('compiler') }}">Compiler</a></li>
      <li><a href="#">About</a></li>
      <li><a href="#">Contact</a></li>
      <li><a href="{{ url_for('logout') }}">Logout</a></li>
    </ul>
  </nav>

  <!-- MAIN LAYOUT -->
  <div class="main-container">
    <!-- History Box -->
    <aside class="history" id="historyBox">
      <h2>History</h2>
      <p>Previous debug 1</p>
      <p>Previous debug 2</p>
    </aside>

    <!-- Debugged Code Section (Left) -->
    <div class="editor-section">
      <h3 style="color: #10a37f; margin-bottom: 0.5rem;">‚ú® Debugged Code (Editable)</h3>
      <div class="editor-wrapper">
        <div class="line-numbers" id="lineNumbers">1</div>
        <div class="code-wrapper">
          <pre class="syntax-highlight" id="syntaxHighlight"><code id="highlightedCode" class="language-python"></code></pre>
          <textarea id="codeInput" placeholder="Auto-fixed code will appear here..."></textarea>
        </div>
        <button class="copy-btn" id="copyFixedBtn">Copy</button>
      </div>
      <button id="debugBtn">üêû Analyze & Debug Code</button>
    </div>

    <!-- Issues Section (Right) -->
    <div class="results" id="results">
      <div class="result-box">
        <h3>üîç Issues Found</h3>
        <div style="position: relative; flex: 1;">
          <div id="issues" style="height: 100%; overflow: auto; background: #1d1d1d; border-radius: 10px;">
            <p style="padding: 2rem; text-align: center; color: #888;">Paste code and click "Analyze & Debug Code" to see issues.</p>
          </div>
          <button class="copy-btn" id="copyIssuesBtn">Copy</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <p>¬© 2025 CODEX. All rights reserved.</p>
  </footer>

  <script>
  const codeInput = document.getElementById("codeInput");
  const lineNumbers = document.getElementById("lineNumbers");
  const debugBtn = document.getElementById("debugBtn");
  const issuesBox = document.getElementById("issues");
  const results = document.getElementById("results");
  const historyBox = document.getElementById("historyBox");
  const highlightedCode = document.getElementById("highlightedCode");
  const syntaxHighlight = document.getElementById("syntaxHighlight");

  let currentLanguage = "python"; // default
  let originalCode = ""; // Store original code
  
  // Map language names to Prism classes
  const languageMap = {
    "python": "python",
    "javascript": "javascript",
    "c": "c",
    "cpp": "cpp",
    "c++": "cpp",
    "java": "java"
  };

  // Load code from localStorage if available (sent from compiler page)
  window.addEventListener("DOMContentLoaded", () => {
    const savedCode = localStorage.getItem("debugCode");
    const savedLanguage = localStorage.getItem("debugLanguage");
    
    if (savedCode) {
      originalCode = savedCode;
      
      // Detect language
      if (savedLanguage) {
        currentLanguage = savedLanguage.toLowerCase();
      }
      
      // Auto-run debug analysis
      runDebugAnalysis(savedCode);
      
      // Clear localStorage after loading
      localStorage.removeItem("debugCode");
      localStorage.removeItem("debugLanguage");
    } else {
      // Show results panel with instructions if no code loaded
      results.style.display = "flex";
      historyBox.style.display = "none";
    }
  });

  // Line numbers update
  function updateLineNumbers() {
    const lines = codeInput.value.split("\n").length;
    lineNumbers.textContent = Array.from({ length: lines }, (_, i) => i + 1).join("\n");
  }
  
  // Update syntax highlighting
  function updateSyntaxHighlight() {
    const code = codeInput.value;
    const language = languageMap[currentLanguage.toLowerCase()] || "python";
    
    highlightedCode.className = `language-${language}`;
    highlightedCode.textContent = code;
    
    if (window.Prism) {
      Prism.highlightElement(highlightedCode);
    }
  }
  
  // Sync scroll
  function syncScroll() {
    if (syntaxHighlight && codeInput) {
      syntaxHighlight.scrollTop = codeInput.scrollTop;
      syntaxHighlight.scrollLeft = codeInput.scrollLeft;
    }
    if (lineNumbers && codeInput) {
      lineNumbers.scrollTop = codeInput.scrollTop;
    }
  }

  codeInput.addEventListener("input", () => {
    updateLineNumbers();
    updateSyntaxHighlight();
  });
  
  codeInput.addEventListener("scroll", syncScroll);

  // Format issues for ChatGPT-style display
  function formatIssues(issuesText) {
    if (!issuesText || issuesText.includes("No issues found") || issuesText.startsWith("‚úÖ")) {
      return '<div class="success-message">üéâ No issues found! Your code looks good. üöÄ</div>';
    }

    if (issuesText.startsWith("‚ùå") || issuesText.startsWith("‚ö†Ô∏è")) {
      return `<div style="padding: 1rem; color: #ff5459; font-size: 1.1rem;">${issuesText} üò¢</div>`;
    }

    // Parse issues and create cards
    const lines = issuesText.split('\n').filter(line => line.trim());
    let formattedHTML = '';
    let currentIssue = null;

    for (let line of lines) {
      // Check if it's a new issue (starts with line number or error type)
      const issueMatch = line.match(/^(.*?):(\d+):(\d+):\s*(error|warning|note):\s*(.+)$/i);
      const simpleMatch = line.match(/^(Line \d+|Error|Warning):\s*(.+)$/i);

      if (issueMatch) {
        if (currentIssue) formattedHTML += createIssueCard(currentIssue);
        const [, file, lineNum, col, type, message] = issueMatch;
        currentIssue = {
          type: type.toLowerCase(),
          line: lineNum,
          title: message,
          description: '',
          code: ''
        };
      } else if (simpleMatch) {
        if (currentIssue) formattedHTML += createIssueCard(currentIssue);
        const [, location, message] = simpleMatch;
        currentIssue = {
          type: location.toLowerCase().includes('warning') ? 'warning' : 'error',
          line: location.match(/\d+/) ? location.match(/\d+/)[0] : '?',
          title: message,
          description: '',
          code: ''
        };
      } else if (currentIssue && line.trim()) {
        // Additional description or code
        if (line.match(/^\s{2,}/) || line.includes('>>>') || line.includes('^')) {
          currentIssue.code += line + '\n';
        } else {
          currentIssue.description += line + ' ';
        }
      }
    }

    if (currentIssue) formattedHTML += createIssueCard(currentIssue);

    // If no formatted HTML was created, show raw text
    if (!formattedHTML || formattedHTML.trim() === '') {
      return `<div style="padding: 1.5rem; color: #ececf1; background: rgba(255, 84, 89, 0.1); border-left: 4px solid #ff5459; border-radius: 8px; margin: 1rem; line-height: 1.8; white-space: pre-wrap; font-family: 'Segoe UI', sans-serif;">${escapeHtml(issuesText)}</div>`;
    }

    // Wrap all cards in a grid container for more color and spacing
    return `<div class="issues-grid">${formattedHTML}</div>`;
  }

  function createIssueCard(issue) {
    const colorMap = {
      'error': '#ff5459',
      'warning': '#ffc107',
      'note': '#6ad7ff'
    };
    const emojiMap = {
      'error': '‚ùå',
      'warning': '‚ö†Ô∏è',
      'note': 'üí°'
    };
    const cardClass = issue.type === 'warning' ? 'warning-card' : 'issue-card';
    const badgeClass = issue.type === 'warning' ? 'warning-badge' : 'error-badge';
    const badgeText = issue.type === 'warning' ? 'Warning' : (issue.type === 'note' ? 'Note' : 'Error');
    const color = colorMap[issue.type] || '#10a37f';
    const emoji = emojiMap[issue.type] || 'üêû';

    let html = `<div class="${cardClass}" style="background: linear-gradient(135deg, ${color}22 0%, #222 100%); border-left: 6px solid ${color}; box-shadow: 0 2px 8px ${color}33; margin: 1rem; padding: 1.2rem 1.5rem; border-radius: 12px; display: flex; flex-direction: column; gap: 0.5rem;">`;
    html += `<span class="issue-badge ${badgeClass}" style="background: ${color}; color: #fff;">${emoji} ${badgeText}</span>`;
    html += ` <span style="color: #888; font-size: 0.85rem;">üìç Line ${issue.line}</span>`;
    html += `<div class="issue-title" style="color: ${color}; font-size: 1.05rem; font-weight: 600; margin: 0.5rem 0;">${escapeHtml(issue.title)}</div>`;

    if (issue.description.trim()) {
      html += `<div class="issue-description" style="color: #ececf1;">${escapeHtml(issue.description.trim())}</div>`;
    }

    if (issue.code.trim()) {
      html += `<div class="issue-code" style="background: #181818; color: #6ad7ff; border-radius: 6px; padding: 0.3rem 0.7rem; margin: 0.3rem 0; font-family: 'Consolas', monospace; font-size: 0.95rem;">${escapeHtml(issue.code.trim())}</div>`;
    }

    html += '</div>';
    return html;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Debug analysis function
  async function runDebugAnalysis(code = null) {
    const codeToAnalyze = code || originalCode;
    
    console.log("Running debug analysis with code:", codeToAnalyze ? "Code present" : "No code");
    
    if (!codeToAnalyze || !codeToAnalyze.trim()) {
      issuesBox.innerHTML = '<div style="padding: 2rem; text-align: center; color: #ffa500;">‚ö†Ô∏è No code to analyze.<br><br>Go to the <a href="/compiler" style="color: #10a37f;">compiler page</a> and click the Debug button.</div>';
      codeInput.value = "";
      results.style.display = "flex";
      historyBox.style.display = "none";
      return;
    }

    // Show loading state
    issuesBox.innerHTML = '<div style="padding: 2rem; text-align: center; color: #10a37f;">üêû Analyzing your code with linters...<br>‚è≥ Please wait...</div>';
    codeInput.value = "‚è≥ Auto-fixing errors...\n\nPlease wait while we analyze and debug your code...";
    results.style.display = "flex";
    historyBox.style.display = "none";

    try {
      console.log("Sending debug request with language:", currentLanguage);
      const response = await fetch("/debug", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: codeToAnalyze, language: currentLanguage })
      });

      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }

      const data = await response.json();
      console.log("Debug response received:", data);
      
      // Display auto-fixed code in left panel (line by line)
      if (data.fixed_code) {
        codeInput.value = data.fixed_code;
        updateLineNumbers();
        updateSyntaxHighlight();
      } else {
        codeInput.value = "# Unable to auto-fix\n\n" + codeToAnalyze;
        updateLineNumbers();
        updateSyntaxHighlight();
      }
      
      // Display issues found by linter in right panel with better formatting
      const issuesText = data.issues || "‚úÖ No issues found! Your code looks good.";
      console.log("Issues text received:", issuesText);
      console.log("Issues text type:", typeof issuesText);
      console.log("Issues text length:", issuesText.length);
      
      if (!issuesText || issuesText.trim() === '') {
        issuesBox.innerHTML = '<div style="padding: 2rem; text-align: center; color: #888;">No issues data received from server.</div>';
      } else {
        const formattedIssues = formatIssues(issuesText);
        console.log("Formatted issues HTML length:", formattedIssues.length);
        issuesBox.innerHTML = formattedIssues;
      }

    } catch (err) {
      issuesBox.innerHTML = '<div class="issue-card"><span class="issue-badge error-badge">Error</span><div class="issue-title">Analysis Failed</div><div class="issue-description">' + err.message + '</div></div>';
      codeInput.value = "# Error during analysis\n\n" + codeToAnalyze;
      updateLineNumbers();
      updateSyntaxHighlight();
    }
  }

  // Debug button handler - re-analyze current code
  debugBtn.addEventListener("click", () => {
    const currentCode = codeInput.value.trim();
    if (currentCode && !currentCode.startsWith("‚è≥") && !currentCode.startsWith("Auto-fixed") && !currentCode.startsWith("#")) {
      originalCode = currentCode;
      runDebugAnalysis(currentCode);
    } else if (originalCode) {
      runDebugAnalysis(originalCode);
    } else {
      issuesBox.innerHTML = '<div style="padding: 2rem; text-align: center; color: #ffa500;">‚ö†Ô∏è No code to analyze.<br><br>Please go to the <a href="/compiler" style="color: #10a37f;">compiler page</a> and click the Debug button, or paste your code in the left panel.</div>';
      results.style.display = "flex";
      historyBox.style.display = "none";
    }
  });

  // Copy Buttons with better feedback
  document.getElementById("copyFixedBtn").addEventListener("click", () => {
    navigator.clipboard.writeText(codeInput.value).then(() => {
      const btn = document.getElementById("copyFixedBtn");
      const originalText = btn.textContent;
      btn.textContent = "‚úì Copied!";
      btn.style.background = "#10a37f";
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = "";
      }, 2000);
    });
  });

  document.getElementById("copyIssuesBtn").addEventListener("click", () => {
    navigator.clipboard.writeText(issuesBox.textContent).then(() => {
      const btn = document.getElementById("copyIssuesBtn");
      const originalText = btn.textContent;
      btn.textContent = "‚úì Copied!";
      btn.style.background = "#10a37f";
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = "";
      }, 2000);
    });
  });
</script>

</body>
</html>
